{% extends "base.html" %}

{% block title %}{% if scale %}Edit{% else %}Add{% endif %} Scale{% endblock %}
{% block page_title %}{% if scale %}Edit{% else %}Add{% endif %} Weighing Scale{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">{% if scale %}Edit{% else %}Add New{% endif %} Weighing Scale</h5>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data">
                    <div class="row">
    <div class="col-md-6 mb-3">
        <label for="supermarket_id" class="form-label">Supermarket *</label>
        <select class="form-select" id="supermarket_id" name="supermarket_id" required>
            <option value="">Select Supermarket</option>
            {% for sm in supermarkets %}
            <option value="{{ sm.id }}" {% if scale and scale.supermarket_id == sm.id %}selected{% endif %}>
                {{ sm.name }}
            </option>
            {% endfor %}
        </select>
    </div>

    <div class="col-md-6 mb-3">
        <label for="branch_id" class="form-label">Branch *</label>
        <select class="form-select" id="branch_id" name="branch_id" required>
            <option value="">Select Branch</option>
        </select>
    </div>
</div>
                    
                     <div class="row">
					 <div class="col-md-6 mb-3">
    <label for="brand" class="form-label">Brand *</label>
    <select class="form-select" id="brand" name="brand" required>
        <option value="">Select Brand</option>
        <option value="Wintec" {% if scale and scale.brand == 'Wintec' %}selected{% endif %}>Wintec</option>
        <option value="Dibal" {% if scale and scale.brand == 'Dibal' %}selected{% endif %}>Dibal</option>
    </select>
</div>

<div class="col-md-6 mb-3">
    <label for="model" class="form-label">Model *</label>
    <select class="form-select" id="model" name="model" required>
        <option value="">Select Model</option>
        <option value="ACS60E" {% if scale and scale.model == 'ACS60E' %}selected{% endif %}>ACS60E</option>
        <option value="M525DB" {% if scale and scale.model == 'M525DB' %}selected{% endif %}>M525DB</option>
    </select>
</div>

                        <div class="col-md-6 mb-3">
    <label for="serial_number" class="form-label">Serial Number *</label>
    <input type="text" class="form-control" id="serial_number" name="serial_number"
           value="{{ scale.serial_number if scale else '' }}" required>
    <div id="serialFeedback" class="invalid-feedback" style="display:none;">
        ⚠️ This serial number already exists.
    </div>
</div>

<div class="col-md-6 mb-3">
    <label for="firmware_number" class="form-label">Firmware Number *</label>
    <select class="form-select" id="firmware_number" name="firmware_number" required>
        <option value="">Select Firmware</option>
        <option value="v3.12.217" {% if scale and scale.firmware_number == 'v3.12.217' %}selected{% endif %}>v3.12.217</option>
        <option value="v3.12.220" {% if scale and scale.firmware_number == 'v3.12.220' %}selected{% endif %}>v3.12.220</option>
		<option value="v3.12.228" {% if scale and scale.firmware_number == 'v3.12.228' %}selected{% endif %}>v3.12.228</option>
		<option value="v3.12.230" {% if scale and scale.firmware_number == 'v3.12.230' %}selected{% endif %}>v3.12.230</option>
    </select>
</div>

                  <!--      <div class="col-md-6 mb-3">
                            <label for="firmware_number" class="form-label">Firmware Number *</label>
                            <input type="text" class="form-control" id="firmware_number" name="firmware_number" 
                                   value="{{ scale.firmware_number if scale else '' }}" required>
                        </div> -->
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="installation_date" class="form-label">Installation Date</label>
                            <input type="date" class="form-control" id="installation_date" name="installation_date" 
                                   value="{{ scale.installation_date if scale else '' }}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="ip_address" class="form-label">IP Address</label>
                            <input type="text" class="form-control" id="ip_address" name="ip_address" 
                                   value="{{ scale.ip_address if scale else '' }}" placeholder="172.0.0.1">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="mac_address" class="form-label">MAC Address</label>
                            <input type="text" class="form-control" id="mac_address" name="mac_address" 
                                   value="{{ scale.mac_address if scale else '' }}" placeholder="00:1B:44:11:3A:B7">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="anydesk_id" class="form-label">AnyDesk ID</label>
                            <input type="text" class="form-control" id="anydesk_id" name="anydesk_id" 
                                   value="{{ scale.anydesk_id if scale else '' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="anydesk_password" class="form-label">AnyDesk Password</label>
                            <input type="text" class="form-control" id="anydesk_password" name="anydesk_password" 
                                   value="{{ scale.anydesk_password if scale else '' }}">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="weight_license_number" class="form-label">Weight License Number</label>
                            <input type="text" class="form-control" id="weight_license_number" name="weight_license_number" 
                                   value="{{ scale.weight_license_number if scale else '' }}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="license_expiry_date" class="form-label">License Expiry Date</label>
                            <input type="date" class="form-control" id="license_expiry_date" name="license_expiry_date" 
                                   value="{{ scale.license_expiry_date if scale else '' }}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="maintenance_status" class="form-label">Maintenance Status *</label>
                            <select class="form-select" id="maintenance_status" name="maintenance_status" required>
                                <option value="active" {% if scale and scale.maintenance_status == 'active' %}selected{% endif %}>Active</option>
                                <option value="expired" {% if scale and scale.maintenance_status == 'expired' %}selected{% endif %}>Expired</option>
                                <option value="pending" {% if scale and scale.maintenance_status == 'pending' %}selected{% endif %}>Pending</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="technician_in_charge" class="form-label">Technician in Charge</label>
                        <input type="text" class="form-control" id="technician_in_charge" name="technician_in_charge" 
                               value="{{ scale.technician_in_charge if scale else '' }}">
                    </div>
                    
                    <div class="mb-3">
                        <label for="document" class="form-label">Installation Document/Photo</label>
                        <input type="file" class="form-control" id="document" name="document" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
                        {% if scale and scale.document_path %}
                        <small class="text-muted">Current file: {{ scale.document_path }}</small>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="remarks" class="form-label">Remarks</label>
                        <textarea class="form-control" id="remarks" name="remarks" rows="3">{{ scale.remarks if scale else '' }}</textarea>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save me-2"></i>Save
                        </button>
                        <a href="{{ url_for('scales') }}" class="btn btn-secondary">
                            <i class="bi bi-x-circle me-2"></i>Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Include SweetAlert2 (if not already in base.html) -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // ===== Existing Branch Loading Logic =====
    const supermarketSelect = document.getElementById('supermarket_id');
    const branchSelect = document.getElementById('branch_id');
    const selectedBranchId = "{{ scale.branch_id if scale else '' }}";
    const selectedSupermarketId = "{{ scale.supermarket_id if scale else '' }}";

    function loadBranches(supermarketId, preselectId = null) {
        branchSelect.innerHTML = '<option value="">Select Branch</option>';

        if (supermarketId) {
            fetch(`/api/branches/${supermarketId}`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(branch => {
                        const option = document.createElement('option');
                        option.value = branch.id;
                        const branchCode = branch.code || '';
                        option.textContent = branchCode
                            ? `${branch.name} | ${branchCode}`
                            : branch.name;
                        if (preselectId && preselectId == branch.id)
                            option.selected = true;
                        branchSelect.appendChild(option);
                    });
                })
                .catch(err => console.error('Error fetching branches:', err));
        }
    }

    supermarketSelect.addEventListener('change', function () {
        loadBranches(this.value);
    });

    if (selectedSupermarketId) {
        loadBranches(selectedSupermarketId, selectedBranchId);
    }

    // ===== New Serial Number Auto-Check Logic =====
    const serialInput = document.getElementById('serial_number');
    const form = serialInput.closest('form');
    let checkTimeout = null;
    let duplicateFound = false; // flag to prevent submission

    serialInput.addEventListener('input', function () {
        clearTimeout(checkTimeout);
        const value = this.value.trim();
        if (!value) {
            serialInput.classList.remove('is-invalid');
            duplicateFound = false;
            return;
        }

        checkTimeout = setTimeout(() => checkSerial(value), 600);
    });

    serialInput.addEventListener('paste', function () {
        clearTimeout(checkTimeout);
        checkTimeout = setTimeout(() => {
            const value = this.value.trim();
            if (value) checkSerial(value);
        }, 500);
    });

    async function checkSerial(serial) {
        try {
            const resp = await fetch(`/check_serial/${encodeURIComponent(serial)}`);
            const data = await resp.json();

            if (data.exists) {
                duplicateFound = true;
                serialInput.classList.add('is-invalid');
                Swal.fire({
                    icon: 'warning',
                    title: 'Duplicate Serial Number!',
                    html: `
                        Serial Number <b>${data.serial_number}</b> already exists.<br>
                        <b>Supermarket:</b> ${data.supermarket || '-'}<br>
                        <b>Branch:</b> ${data.branch || '-'}
                    `,
                    confirmButtonText: 'OK'
                });
            } else {
                duplicateFound = false;
                serialInput.classList.remove('is-invalid');
            }
        } catch (err) {
            console.error('Error checking serial:', err);
        }
    }

    // ===== Prevent Form Submission if Duplicate =====
    form.addEventListener('submit', function (e) {
        if (duplicateFound) {
            e.preventDefault();
            Swal.fire({
                icon: 'error',
                title: 'Duplicate Found',
                text: 'This serial number already exists. Please use a unique serial number.',
                confirmButtonText: 'OK'
            });
        }
    });
});
</script>

{% endblock %}
<!-- templates/monitoring.html -->
{% if current_user.is_authenticated %}
    {% set base_template = "base.html" %}
{% else %}
    {% set base_template = "base_public.html" %}
{% endif %}

{% extends base_template %}

{% block title %}Weighing Scales Monitoring{% endblock %}
{% block page_title %}Weighing Scale Monitoring{% endblock %}

{% block content %}
<div class="alert alert-success" id="shareAlert" style="display: none;">
    Link copied to clipboard! Share this URL with others.
</div>

<!-- ADD EXPORT BUTTON HERE -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="page-title mb-0">Weighing Scales Monitoring</h3>
    <div class="d-flex gap-2">
        <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#exportModal">
            <i class="bi bi-file-earmark-pdf me-2"></i>Export PDF
        </button>
    </div>
</div>

{% if current_user.is_authenticated %}
<div class="card mb-4">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title mb-0">üîç Search Filters</h5>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleFilters()" id="toggleBtn">
                <i class="bi bi-chevron-up" id="toggleIcon"></i>
                <span id="toggleText">Show Filters</span>
            </button>
        </div>
        <div id="filterSection" style="display: none;">
            <form method="GET" action="/monitoring" id="searchForm" class="row g-3">
                <div class="col-md-4">
                    <label for="supermarket" class="form-label">Supermarket</label>
                    <select id="supermarket" name="supermarket" class="form-select">
                        <option value="">All Supermarkets</option>
                        {% for supermarket in supermarkets %}
                        <option value="{{ supermarket.name }}" {% if search_supermarket == supermarket.name %}selected{% endif %}>
                            {{ supermarket.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="branch" class="form-label">Branch Name/Code</label>
                    <input type="text" id="branch" name="branch" class="form-control" placeholder="Search branch..." value="{{ search_branch }}">
                </div>
                <div class="col-md-4">
                    <label for="serial" class="form-label">Serial Number</label>
                    <input type="text" id="serial" name="serial" class="form-control" placeholder="Search serial..." value="{{ search_serial }}">
                </div>
                <div class="col-md-4">
                    <label for="brand" class="form-label">Brand</label>
                    <select id="brand" name="brand" class="form-select">
                        <option value="">All Brands</option>
                        {% for brand in brands %}
                        <option value="{{ brand.brand }}" {% if search_brand == brand.brand %}selected{% endif %}>
                            {{ brand.brand }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="state" class="form-label">State</label>
                    <select id="state" name="state" class="form-select">
                        <option value="">All States</option>
                        {% for state in states %}
                        <option value="{{ state.state }}" {% if search_state == state.state %}selected{% endif %}>
                            {{ state.state }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4 d-flex align-items-end gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-search me-2"></i>Search
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">
                        <i class="bi bi-arrow-clockwise me-2"></i>Reset
                    </button>
                    <button type="button" class="btn btn-success" onclick="shareURL()">
                        <i class="bi bi-share me-2"></i>Share
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- Scales Table -->
<div class="card">
    <div class="card-body">
        <div class="d-flex justify-content-end align-items-center mb-3">
            <span class="badge bg-primary">Found <strong>{{ results|length }}</strong> scale(s)</span>
        </div>
        <div class="table-responsive">
            {% if results %}
            <table class="table table-hover table-bordered" id="monitoringTable">
                <thead>
                    <tr>
                        <th style="width: 50px;">No.</th>
                        <th>Supermarket</th>
                        <th>Branch</th>
                        <th>Code</th>
                        <th>State</th>
                        <th>S/No</th>
                        <th>Firmware</th>
                        <th>IP Address</th>
                        <th>AnyDesk</th>
                        <th>App_Version</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in results %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td><strong>{{ row.supermarket_name }}</strong></td>
                        <td><strong>{{ row.branch_name }}</strong></td>
                        <td><center><span class="badge bg-secondary">{{ row.branch_code or '-' }}</span></center></td>
                        <td>{{ row.state }}</td>
                        <td><strong>{{ row.serial_number }}</strong></td>
                        <td><span class="badge bg-info">{{ row.firmware_number or '-' }}</span></td>
                        <td>{{ row.ip_address or '-' }}</td>
                        <td>{{ row.anydesk_id or '-' }}</td>
                        <td><center><span class="badge bg-secondary">{{ row.app_version or '-' }}</span></center></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="text-center py-5">
                <i class="bi bi-search" style="font-size: 3rem; color: #ccc;"></i>
                <h4 class="mt-3">No Results Found</h4>
                <p class="text-muted">Try adjusting your search criteria</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Export Column Selection Modal -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="exportModalLabel">
                    <i class="bi bi-file-earmark-pdf me-2"></i>Select Columns to Export
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info alert-sm">
                    <i class="bi bi-info-circle me-2"></i>Select which columns you want to include in the PDF export
                </div>
                
                <form id="exportForm">
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="selectAll" checked>
                            <label class="form-check-label fw-bold" for="selectAll">
                                Select All / Deselect All
                            </label>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check mb-2">
                                <input class="form-check-input column-checkbox" type="checkbox" value="supermarket" id="col_supermarket" checked>
                                <label class="form-check-label" for="col_supermarket">
                                    Supermarket
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input column-checkbox" type="checkbox" value="branch" id="col_branch" checked>
                                <label class="form-check-label" for="col_branch">
                                    Branch
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input column-checkbox" type="checkbox" value="code" id="col_code" checked>
                                <label class="form-check-label" for="col_code">
                                    Code
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input column-checkbox" type="checkbox" value="state" id="col_state" checked>
                                <label class="form-check-label" for="col_state">
                                    State
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input column-checkbox" type="checkbox" value="serial" id="col_serial" checked>
                                <label class="form-check-label" for="col_serial">
                                    Serial Number
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check mb-2">
                                <input class="form-check-input column-checkbox" type="checkbox" value="firmware" id="col_firmware" checked>
                                <label class="form-check-label" for="col_firmware">
                                    Firmware
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input column-checkbox" type="checkbox" value="ip" id="col_ip" checked>
                                <label class="form-check-label" for="col_ip">
                                    IP Address
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input column-checkbox" type="checkbox" value="anydesk" id="col_anydesk" checked>
                                <label class="form-check-label" for="col_anydesk">
                                    AnyDesk
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input column-checkbox" type="checkbox" value="version" id="col_version" checked>
                                <label class="form-check-label" for="col_version">
                                    App Version
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-danger" id="confirmExportBtn">
                    <i class="bi bi-download me-2"></i>Export PDF
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Export PDF with column selection
document.addEventListener('DOMContentLoaded', function() {
    const searchForm = document.getElementById('searchForm');
    const selectAllCheckbox = document.getElementById('selectAll');
    const columnCheckboxes = document.querySelectorAll('.column-checkbox');
    const confirmExportBtn = document.getElementById('confirmExportBtn');
    
    // Select All / Deselect All functionality
    selectAllCheckbox.addEventListener('change', function() {
        columnCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
    });
    
    // Update Select All checkbox when individual checkboxes change
    columnCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const allChecked = Array.from(columnCheckboxes).every(cb => cb.checked);
            const noneChecked = Array.from(columnCheckboxes).every(cb => !cb.checked);
            selectAllCheckbox.checked = allChecked;
            selectAllCheckbox.indeterminate = !allChecked && !noneChecked;
        });
    });
    
    // Export PDF button click
    confirmExportBtn.addEventListener('click', function() {
        // Get selected columns
        const selectedColumns = Array.from(columnCheckboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);
        
        if (selectedColumns.length === 0) {
            alert('Please select at least one column to export!');
            return;
        }
        
        // Build query string from current filters
        const formData = new FormData(searchForm);
        const params = new URLSearchParams(formData);
        
        // Add selected columns to params
        params.append('columns', selectedColumns.join(','));
        
        const url = '/export/monitoring/pdf?' + params.toString();
        
        // Close modal and redirect to export URL
        const modal = bootstrap.Modal.getInstance(document.getElementById('exportModal'));
        modal.hide();
        
        // Redirect to export URL
        window.location.href = url;
    });
});

function toggleFilters() {
    const filterSection = document.getElementById('filterSection');
    const toggleIcon = document.getElementById('toggleIcon');
    const toggleText = document.getElementById('toggleText');
    
    if (filterSection.style.display === 'none') {
        filterSection.style.display = 'block';
        toggleIcon.className = 'bi bi-chevron-up';
        toggleText.textContent = 'Hide Filters';
    } else {
        filterSection.style.display = 'none';
        toggleIcon.className = 'bi bi-chevron-down';
        toggleText.textContent = 'Show Filters';
    }
}

function resetForm() {
    document.getElementById('searchForm').reset();
    window.location.href = '/monitoring';
}

function shareURL() {
    let url = window.location.href;
    
    if (url.includes('127.0.0.1') || url.includes('localhost')) {
        const port = window.location.port ? `:${window.location.port}` : '';
        const protocol = window.location.protocol;
        const hostname = getLocalIP();
        url = `${protocol}//${hostname}${port}${window.location.pathname}${window.location.search}`;
    }
    
    navigator.clipboard.writeText(url).then(() => {
        const alertBox = document.getElementById('shareAlert');
        alertBox.style.display = 'block';
        setTimeout(() => alertBox.style.display = 'none', 3000);
    }).catch(err => {
        console.error('Failed to copy: ', err);
    });
    
    console.log("Shareable URL:", url);
}

function getLocalIP() {
    return '192.168.0.115';
}

const selectElements = document.querySelectorAll('select');
selectElements.forEach(function(select) {
    select.addEventListener('change', function() {
        // document.getElementById('searchForm').submit();
    });
});
</script>

{% endblock %}

{% block extra_js %}
<script>
function validateAnydesk(id) {
    const regex = /^[0-9]{6,12}$/;
    if (!regex.test(id)) {
        alert("Invalid AnyDesk ID.");
        return false;
    }
    return true;
}

function copyAnydesk(id) {
    navigator.clipboard.writeText(id).then(() => {
        alert("AnyDesk ID copied: " + id);
    });
}

function connectAnydesk(id) {
    if (!validateAnydesk(id)) return;
    
    window.location.href = "anydesk:" + id;
    
    setTimeout(() => {
        if (!document.hidden) {
            alert("Unable to open AnyDesk. Make sure AnyDesk is installed.");
        }
    }, 1200);
}
</script>
{% endblock %}
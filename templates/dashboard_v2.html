<!-- templates/dashboard.html -->
{% extends "base.html" %}

{% block title %}Dashboard - Weighing Scale Management{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block extra_css %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');

    :root {
        --primary: #6366f1;
        --primary-light: #818cf8;
        --primary-dark: #4f46e5;
        --secondary: #8b5cf6;
        --accent: #ec4899;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --info: #3b82f6;
        --dark: #0f172a;
        --dark-light: #1e293b;
        --gray: #64748b;
        --light: #f1f5f9;
        --card-bg: rgba(255, 255, 255, 0.95);
    }

    body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        min-height: 100vh;
    }

    /* Animated Background */
    .dashboard-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
        overflow: hidden;
        pointer-events: none;
    }

    .bg-orb {
        position: absolute;
        border-radius: 50%;
        filter: blur(100px);
        opacity: 0.3;
        animation: orb-float 20s ease-in-out infinite;
    }

    .orb-1 {
        width: 500px;
        height: 500px;
        background: radial-gradient(circle, var(--primary) 0%, transparent 70%);
        top: -200px;
        right: -100px;
    }

    .orb-2 {
        width: 400px;
        height: 400px;
        background: radial-gradient(circle, var(--accent) 0%, transparent 70%);
        bottom: -150px;
        left: -100px;
        animation-delay: 5s;
    }

    .orb-3 {
        width: 350px;
        height: 350px;
        background: radial-gradient(circle, var(--secondary) 0%, transparent 70%);
        top: 40%;
        left: 50%;
        animation-delay: 10s;
    }

    @keyframes orb-float {
        0%, 100% { transform: translate(0, 0) scale(1); }
        33% { transform: translate(50px, -50px) scale(1.1); }
        66% { transform: translate(-50px, 50px) scale(0.9); }
    }

    .content-wrapper {
        position: relative;
        z-index: 1;
    }

    /* Dashboard Header */
    .dashboard-header {
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.95) 0%, rgba(139, 92, 246, 0.95) 100%);
        backdrop-filter: blur(20px);
        border-radius: 24px;
        padding: 35px 40px;
        margin-bottom: 35px;
        box-shadow: 
            0 0 0 1px rgba(255, 255, 255, 0.1),
            0 20px 60px rgba(99, 102, 241, 0.4);
        animation: header-entrance 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        position: relative;
        overflow: hidden;
    }

    .dashboard-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        animation: shimmer 3s infinite;
    }

    @keyframes header-entrance {
        from {
            opacity: 0;
            transform: translateY(-30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes shimmer {
        0% { left: -100%; }
        50%, 100% { left: 200%; }
    }

    .dashboard-header h4 {
        font-size: 28px;
        font-weight: 800;
        color: white;
        margin-bottom: 8px;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .user-info {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .user-avatar {
        width: 60px;
        height: 60px;
        border-radius: 20px;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.3);
        animation: avatar-pulse 3s ease-in-out infinite;
    }

    @keyframes avatar-pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }

    .user-details p {
        margin: 0;
        color: white;
    }

    .user-details .fw-bold {
        font-size: 16px;
        text-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    .user-details .small {
        font-size: 13px;
        opacity: 0.9;
    }

    /* Stat Cards */
    .stat-card {
        background: var(--card-bg);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        padding: 28px;
        box-shadow: 
            0 0 0 1px rgba(255, 255, 255, 0.1),
            0 10px 40px rgba(0, 0, 0, 0.3);
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        border-left: 4px solid;
        height: 100%;
        position: relative;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200px;
        height: 200px;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
        border-radius: 50%;
        transition: all 0.4s ease;
    }

    .stat-card:hover {
        transform: translateY(-8px);
        box-shadow: 
            0 0 0 1px rgba(255, 255, 255, 0.2),
            0 20px 60px rgba(0, 0, 0, 0.4);
    }

    .stat-card:hover::before {
        top: -30%;
        right: -30%;
    }

    .stat-card .stat-icon {
        font-size: 42px;
        opacity: 0.9;
        animation: icon-float 3s ease-in-out infinite;
    }

    @keyframes icon-float {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-5px); }
    }

    .stat-card h3 {
        font-size: 36px;
        font-weight: 900;
        margin: 15px 0 8px;
        background: linear-gradient(135deg, var(--dark) 0%, var(--gray) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .stat-card p {
        margin: 0;
        font-size: 14px;
        color: var(--gray);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .stat-card small {
        font-size: 12px;
        color: var(--gray);
        opacity: 0.8;
    }

    .stat-card .form-select {
        margin-top: 12px;
        border-radius: 12px;
        border: 2px solid #e2e8f0;
        padding: 8px 12px;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .stat-card .form-select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    /* Quick Action Cards */
    .section-header {
        margin-bottom: 25px;
    }

    .section-header h4 {
        font-size: 22px;
        font-weight: 800;
        color: white;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .section-header h4::before {
        content: '';
        width: 4px;
        height: 28px;
        background: linear-gradient(to bottom, var(--primary), var(--accent));
        border-radius: 2px;
    }

    .quick-action-card {
        background: var(--card-bg);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        padding: 28px 20px;
        text-align: center;
        box-shadow: 
            0 0 0 1px rgba(255, 255, 255, 0.1),
            0 8px 32px rgba(0, 0, 0, 0.3);
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        position: relative;
        overflow: hidden;
    }

    .quick-action-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .quick-action-card:hover::before {
        opacity: 0.05;
    }

    .quick-action-card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 
            0 0 0 1px rgba(255, 255, 255, 0.2),
            0 16px 48px rgba(99, 102, 241, 0.4);
    }

    .quick-action-card .action-icon {
        font-size: 40px;
        margin-bottom: 15px;
        background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        transition: all 0.3s ease;
        position: relative;
        z-index: 1;
    }

    .quick-action-card:hover .action-icon {
        transform: scale(1.1) rotate(5deg);
    }

    .quick-action-card h5 {
        margin: 0;
        font-weight: 700;
        font-size: 15px;
        color: var(--dark);
        position: relative;
        z-index: 1;
    }

    /* Cards */
    .card {
        background: var(--card-bg);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        border: none;
        box-shadow: 
            0 0 0 1px rgba(255, 255, 255, 0.1),
            0 10px 40px rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
        overflow: hidden;
    }

    .card:hover {
        box-shadow: 
            0 0 0 1px rgba(255, 255, 255, 0.2),
            0 15px 50px rgba(0, 0, 0, 0.4);
    }

    .card-header {
        background: linear-gradient(to right, rgba(248, 249, 250, 0.8), rgba(233, 236, 239, 0.8));
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(226, 232, 240, 0.5);
        border-radius: 20px 20px 0 0 !important;
        font-weight: 700;
        padding: 20px 25px;
        font-size: 15px;
        color: var(--dark);
    }

    .card-header i {
        color: var(--primary);
        font-size: 18px;
    }

    /* Chart Container */
    .chart-container {
        position: relative;
        height: 320px;
        padding: 15px;
    }

    /* Table Styles */
    .table {
        margin-bottom: 0;
    }

    .table th {
        border-top: none;
        font-weight: 700;
        color: var(--dark);
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 16px 20px;
        background: rgba(248, 249, 250, 0.5);
    }

    .table td {
        padding: 16px 20px;
        vertical-align: middle;
        color: var(--dark-light);
        font-size: 14px;
        font-weight: 500;
    }

    .table tbody tr {
        transition: all 0.2s ease;
        border-bottom: 1px solid rgba(226, 232, 240, 0.3);
    }

    .table tbody tr:hover {
        background: rgba(99, 102, 241, 0.03);
        transform: scale(1.01);
    }

    .table a {
        color: var(--primary);
        font-weight: 600;
        transition: all 0.2s ease;
    }

    .table a:hover {
        color: var(--primary-dark);
        text-decoration: underline;
    }

    /* Badges */
    .badge {
        font-weight: 600;
        padding: 6px 14px;
        border-radius: 12px;
        font-size: 12px;
        letter-spacing: 0.3px;
    }

    /* Buttons */
    .btn {
        font-weight: 600;
        border-radius: 12px;
        padding: 8px 16px;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }

    .btn-outline-primary {
        border-color: var(--primary);
        color: var(--primary);
    }

    .btn-outline-primary:hover {
        background: var(--primary);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
    }

    .btn-outline-secondary {
        border-color: var(--gray);
        color: var(--gray);
    }

    .btn-outline-secondary:hover {
        background: var(--gray);
        color: white;
    }

    /* Dropdown Menu */
    .dropdown-menu {
        border-radius: 16px;
        border: none;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        padding: 8px;
        backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.98);
    }

    .dropdown-item {
        border-radius: 10px;
        padding: 10px 16px;
        font-weight: 500;
        font-size: 14px;
        transition: all 0.2s ease;
    }

    .dropdown-item:hover {
        background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
        color: white;
        transform: translateX(5px);
    }

    /* Animations */
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .fade-in {
        animation: fadeIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        opacity: 0;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .dashboard-header {
            padding: 25px 20px;
        }

        .dashboard-header h4 {
            font-size: 22px;
        }

        .stat-card {
            padding: 20px;
        }

        .stat-card h3 {
            font-size: 28px;
        }

        .quick-action-card {
            padding: 20px 15px;
        }

        .section-header h4 {
            font-size: 18px;
        }
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
        width: 10px;
    }

    ::-webkit-scrollbar-track {
        background: rgba(15, 23, 42, 0.5);
    }

    ::-webkit-scrollbar-thumb {
        background: linear-gradient(to bottom, var(--primary), var(--accent));
        border-radius: 5px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(to bottom, var(--primary-dark), var(--accent));
    }
</style>
{% endblock %}

{% block content %}
<!-- Animated Background -->
<div class="dashboard-bg">
    <div class="bg-orb orb-1"></div>
    <div class="bg-orb orb-2"></div>
    <div class="bg-orb orb-3"></div>
</div>

<div class="content-wrapper">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h4>Welcome back, {{ current_user.username|capitalize }}! ðŸ‘‹</h4>
            </div>
            <div class="col-md-4 text-md-end">
                <div class="user-info justify-content-md-end">
                    <div class="user-avatar">
                        <i class="bi bi-person-circle"></i>
                    </div>
                    <div class="user-details">
                        <p class="fw-bold">{{ current_user.role|capitalize }}</p>
                        <p class="small opacity-75">Last login: {{ current_user.last_login or 'Today' }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row g-4 mb-4">
        <div class="col-md-3 fade-in" style="animation-delay: 0.1s;">
            <div class="stat-card" style="border-left-color: var(--danger);">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p>Expiring Licenses</p>
                        <h3>{{ stats.expiring_licenses }}</h3>
                        <small>Next 30 days</small>
                    </div>
                    <i class="bi bi-exclamation-triangle stat-icon text-danger"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3 fade-in" style="animation-delay: 0.2s;">
            <div class="stat-card" style="border-left-color: var(--success);">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p>Total Supermarkets</p>
                        <h3>{{ stats.total_supermarkets }}</h3>
                        <small>In operation</small>
                    </div>
                    <i class="bi bi-check-circle stat-icon text-success"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3 fade-in" style="animation-delay: 0.3s;">
            <div class="stat-card" style="border-left-color: var(--warning);">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="flex-grow-1">
                        <p>Total Branches</p>
                        <h3 id="total-branches-value">{{ stats.total_branches }}</h3>
                        <select class="form-select form-select-sm" id="supermarket-filter-branches">
                            <option value="all" selected>All Supermarkets</option>
                            {% for supermarket in supermarkets %}
                                <option value="{{ supermarket.id }}">{{ supermarket.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <i class="bi bi-shop stat-icon text-warning"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3 fade-in" style="animation-delay: 0.4s;">
            <div class="stat-card" style="border-left-color: var(--info);">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="flex-grow-1">
                        <p>Total Scales</p>
                        <h3 id="total-scales-value">{{ stats.total_scales }}</h3>
                        <select class="form-select form-select-sm" id="supermarket-filter-scales">
                            <option value="all" selected>All Supermarkets</option>
                            {% for supermarket in supermarkets %}
                            <option value="{{ supermarket.id }}">{{ supermarket.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <i class="bi bi-speedometer2 stat-icon text-info"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row g-4 mb-4">
        <div class="col-12">
            <div class="section-header">
                <h4>Quick Actions</h4>
            </div>
        </div>
        <div class="col-md-2 col-sm-4 col-6 fade-in" style="animation-delay: 0.5s;">
            <a href="{{ url_for('add_scale') }}" class="text-decoration-none">
                <div class="quick-action-card">
                    <i class="bi bi-plus-circle action-icon"></i>
                    <h5>Add Scale</h5>
                </div>
            </a>
        </div>
        <div class="col-md-2 col-sm-4 col-6 fade-in" style="animation-delay: 0.6s;">
            <a href="{{ url_for('scales') }}" class="text-decoration-none">
                <div class="quick-action-card">
                    <i class="bi bi-list-ul action-icon"></i>
                    <h5>All Scales</h5>
                </div>
            </a>
        </div>
        <div class="col-md-2 col-sm-4 col-6 fade-in" style="animation-delay: 0.7s;">
            <a href="{{ url_for('expiring_licenses') }}" class="text-decoration-none">
                <div class="quick-action-card">
                    <i class="bi bi-files action-icon"></i>
                    <h5>Licenses</h5>
                </div>
            </a>
        </div>
        <div class="col-md-2 col-sm-4 col-6 fade-in" style="animation-delay: 0.8s;">
            <a href="{{ url_for('supermarkets') }}" class="text-decoration-none">
                <div class="quick-action-card">
                    <i class="bi bi-buildings action-icon"></i>
                    <h5>Customers</h5>
                </div>
            </a>
        </div>
        <div class="col-md-2 col-sm-4 col-6 fade-in" style="animation-delay: 0.9s;">
            <a href="{{ url_for('branches') }}" class="text-decoration-none">
                <div class="quick-action-card">
                    <i class="bi bi-geo-alt action-icon"></i>
                    <h5>Branches</h5>
                </div>
            </a>
        </div>
        <div class="col-md-2 col-sm-4 col-6 fade-in" style="animation-delay: 1.0s;">
            <a href="{{ url_for('export_scales_pdf') }}" class="text-decoration-none">
                <div class="quick-action-card">
                    <i class="bi bi-file-earmark-pdf action-icon"></i>
                    <h5>Export PDF</h5>
                </div>
            </a>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row g-4 mb-4">
        <div class="col-md-6 fade-in" style="animation-delay: 1.1s;">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <i class="bi bi-bar-chart me-2"></i>Installation per State
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="stateChartDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-three-dots"></i>
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="stateChartDropdown">
                            <li><a class="dropdown-item" href="#" onclick="changeChartType('state', 'bar')"><i class="bi bi-bar-chart me-2"></i>Bar Chart</a></li>
                            <li><a class="dropdown-item" href="#" onclick="changeChartType('state', 'line')"><i class="bi bi-graph-up me-2"></i>Line Chart</a></li>
                            <li><a class="dropdown-item" href="#" onclick="changeChartType('state', 'doughnut')"><i class="bi bi-pie-chart me-2"></i>Doughnut Chart</a></li>
                        </ul>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="stateChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6 fade-in" style="animation-delay: 1.2s;">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <i class="bi bi-pie-chart me-2"></i>Maintenance Status
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="maintenanceChartDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-three-dots"></i>
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="maintenanceChartDropdown">
                            <li><a class="dropdown-item" href="#" onclick="changeChartType('maintenance', 'doughnut')"><i class="bi bi-pie-chart me-2"></i>Doughnut Chart</a></li>
                            <li><a class="dropdown-item" href="#" onclick="changeChartType('maintenance', 'pie')"><i class="bi bi-pie-chart-fill me-2"></i>Pie Chart</a></li>
                            <li><a class="dropdown-item" href="#" onclick="changeChartType('maintenance', 'bar')"><i class="bi bi-bar-chart me-2"></i>Bar Chart</a></li>
                        </ul>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="maintenanceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tables Row -->
    <div class="row g-4">
        <div class="col-md-6 fade-in" style="animation-delay: 1.3s;">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <i class="bi bi-clock-history me-2"></i>Upcoming License Expiry
                    </div>
                    <a href="{{ url_for('expiring_licenses') }}" class="btn btn-sm btn-outline-primary">View All</a>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Serial Number</th>
                                    <th>Supermarket</th>
                                    <th>Branch</th>
                                    <th>Days Left</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if expiring_licenses %}
                                    {% for scale in expiring_licenses %}
                                    <tr>
                                        <td><a href="{{ url_for('scale_detail', id=scale.id) }}" class="text-decoration-none">{{ scale.serial_number }}</a></td>
                                        <td>{{ scale.supermarket }}</td>
                                        <td>{{ scale.branch_name }}</td>
                                        <td>
                                            {% if scale.days_left is not none %}
                                                <span class="badge bg-{% if scale.days_left <= 7 %}danger{% elif scale.days_left <= 15 %}warning{% else %}info{% endif %}">
                                                    {{ scale.days_left }} days
                                                </span>
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="4" class="text-center py-4 text-muted">
                                            <i class="bi bi-check-circle me-2"></i>No licenses expiring soon
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6 fade-in" style="animation-delay: 1.4s;">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <i class="bi bi-tools me-2"></i>Latest Maintenance Records
                    </div>
                    <a href="{{ url_for('maintenance') }}" class="btn btn-sm btn-outline-primary">View All</a>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Scale</th>
                                    <th>Technician</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if latest_maintenance %}
                                    {% for record in latest_maintenance %}
                                    <tr>
                                        <td>{{ record.service_date }}</td>
                                        <td><a href="{{ url_for('scale_detail', id=record.scale_id) }}" class="text-decoration-none">{{ record.serial_number }}</a></td>
                                        <td>{{ record.technician_name }}</td>
                                        <td><span class="badge bg-success">Completed</span></td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="4" class="text-center py-4 text-muted">
                                            <i class="bi bi-inbox me-2"></i>No maintenance records yet
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Activity Logs (Admin Only) -->
    {% if current_user.username in ['adib'] %}
    <div class="card mt-4 fade-in" style="animation-delay: 1.5s;">
        <div class="card-header">
            <i class="bi bi-journal-text me-2"></i>Recent Activity Logs
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Action</th>
                            <th>Table</th>
                            <th>Record ID</th>
                            <th>Old Data</th>
                            <th>New Data</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in logs %}
                        <tr>
                            <td>{{ log.username }}</td>
                            <td><span class="badge bg-primary">{{ log.action }}</span></td>
                            <td>{{ log.table_name }}</td>
                            <td>{{ log.record_id or '-' }}</td>
                            <td>{{ log.old_data or '-' }}</td>
                            <td>{{ log.new_data or '-' }}</td>
                            <td>{{ log.timestamp }}</td>
                        </tr>
                        {% endfor %}
                        {% if logs|length == 0 %}
                        <tr>
                            <td colspan="7" class="text-center py-4 text-muted">
                                <i class="bi bi-inbox me-2"></i>No recent activity.
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    // State Chart
    const stateCtx = document.getElementById('stateChart').getContext('2d');
    const stateData = {{ state_data|tojson }};
    
    let stateChart = new Chart(stateCtx, {
        type: 'bar',
        data: {
            labels: stateData.map(d => d.state),
            datasets: [{
                label: 'Number of Scales',
                data: stateData.map(d => d.count),
                backgroundColor: 'rgba(99, 102, 241, 0.8)',
                borderColor: 'rgba(99, 102, 241, 1)',
                borderWidth: 2,
                borderRadius: 10,
                hoverBackgroundColor: 'rgba(99, 102, 241, 1)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(15, 23, 42, 0.95)',
                    padding: 16,
                    cornerRadius: 12,
                    titleFont: {
                        size: 15,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 14
                    },
                    borderColor: 'rgba(99, 102, 241, 0.5)',
                    borderWidth: 1
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        font: {
                            size: 12,
                            weight: '600'
                        },
                        color: '#64748b'
                    },
                    grid: {
                        color: 'rgba(226, 232, 240, 0.3)',
                        drawBorder: false
                    }
                },
                x: {
                    ticks: {
                        font: {
                            size: 12,
                            weight: '600'
                        },
                        color: '#64748b'
                    },
                    grid: {
                        display: false
                    }
                }
            },
            animation: {
                duration: 1200,
                easing: 'easeOutQuart'
            }
        }
    });

    // Maintenance Status Chart
    const maintenanceCtx = document.getElementById('maintenanceChart').getContext('2d');
    const maintenanceData = {{ maintenance_data|tojson }};
    
    let maintenanceChart = new Chart(maintenanceCtx, {
        type: 'doughnut',
        data: {
            labels: maintenanceData.map(d => d.maintenance_status.charAt(0).toUpperCase() + d.maintenance_status.slice(1)),
            datasets: [{
                data: maintenanceData.map(d => d.count),
                backgroundColor: [
                    'rgba(16, 185, 129, 0.8)',
                    'rgba(239, 68, 68, 0.8)',
                    'rgba(245, 158, 11, 0.8)'
                ],
                borderColor: [
                    'rgba(16, 185, 129, 1)',
                    'rgba(239, 68, 68, 1)',
                    'rgba(245, 158, 11, 1)'
                ],
                borderWidth: 3,
                hoverOffset: 20,
                hoverBorderWidth: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        font: {
                            size: 13,
                            weight: '600'
                        },
                        color: '#1e293b',
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(15, 23, 42, 0.95)',
                    padding: 16,
                    cornerRadius: 12,
                    titleFont: {
                        size: 15,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 14
                    },
                    borderColor: 'rgba(99, 102, 241, 0.5)',
                    borderWidth: 1
                }
            },
            animation: {
                animateRotate: true,
                animateScale: true,
                duration: 1200,
                easing: 'easeOutQuart'
            }
        }
    });

    // Function to change chart type
    function changeChartType(chartName, newType) {
        if (chartName === 'state') {
            stateChart.destroy();
            stateChart = new Chart(stateCtx, {
                type: newType,
                data: {
                    labels: stateData.map(d => d.state),
                    datasets: [{
                        label: 'Number of Scales',
                        data: stateData.map(d => d.count),
                        backgroundColor: 'rgba(99, 102, 241, 0.8)',
                        borderColor: 'rgba(99, 102, 241, 1)',
                        borderWidth: 2,
                        borderRadius: 10,
                        hoverBackgroundColor: 'rgba(99, 102, 241, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: newType === 'doughnut' || newType === 'pie',
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: { size: 13, weight: '600' },
                                color: '#1e293b',
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.95)',
                            padding: 16,
                            cornerRadius: 12,
                            borderColor: 'rgba(99, 102, 241, 0.5)',
                            borderWidth: 1
                        }
                    },
                    scales: newType === 'bar' || newType === 'line' ? {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                font: { size: 12, weight: '600' },
                                color: '#64748b'
                            },
                            grid: {
                                color: 'rgba(226, 232, 240, 0.3)'
                            }
                        },
                        x: {
                            ticks: {
                                font: { size: 12, weight: '600' },
                                color: '#64748b'
                            },
                            grid: {
                                display: false
                            }
                        }
                    } : {},
                    animation: {
                        duration: 1200,
                        easing: 'easeOutQuart'
                    }
                }
            });
        } else if (chartName === 'maintenance') {
            maintenanceChart.destroy();
            maintenanceChart = new Chart(maintenanceCtx, {
                type: newType,
                data: {
                    labels: maintenanceData.map(d => d.maintenance_status.charAt(0).toUpperCase() + d.maintenance_status.slice(1)),
                    datasets: [{
                        data: maintenanceData.map(d => d.count),
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(245, 158, 11, 0.8)'
                        ],
                        borderColor: [
                            'rgba(16, 185, 129, 1)',
                            'rgba(239, 68, 68, 1)',
                            'rgba(245, 158, 11, 1)'
                        ],
                        borderWidth: 3,
                        borderRadius: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: newType === 'doughnut' || newType === 'pie',
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: { size: 13, weight: '600' },
                                color: '#1e293b',
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.95)',
                            padding: 16,
                            cornerRadius: 12,
                            borderColor: 'rgba(99, 102, 241, 0.5)',
                            borderWidth: 1
                        }
                    },
                    scales: newType === 'bar' ? {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                font: { size: 12, weight: '600' },
                                color: '#64748b'
                            },
                            grid: {
                                color: 'rgba(226, 232, 240, 0.3)'
                            }
                        },
                        x: {
                            ticks: {
                                font: { size: 12, weight: '600' },
                                color: '#64748b'
                            },
                            grid: {
                                display: false
                            }
                        }
                    } : {},
                    animation: {
                        duration: 1200,
                        easing: 'easeOutQuart'
                    }
                }
            });
        }
    }

    // Prevent auto-scroll on page load
    if (history.scrollRestoration) {
        history.scrollRestoration = 'manual';
    }

    window.addEventListener('beforeunload', function() {
        window.scrollTo(0, 0);
    });

    window.addEventListener('load', function() {
        setTimeout(function() {
            window.scrollTo(0, 0);
        }, 0);
    });

    // Update total scales
    document.getElementById('supermarket-filter-scales').addEventListener('change', function() {
        const supermarketId = this.value;
        fetch(`/api/scales/count?supermarket_id=${supermarketId}`)
            .then(res => res.json())
            .then(data => {
                document.getElementById('total-scales-value').textContent = data.total_scales;
            })
            .catch(err => console.error(err));
    });

    // Update total branches
    document.getElementById('supermarket-filter-branches').addEventListener('change', function() {
        const supermarketId = this.value;
        let url = '';
        if (supermarketId === 'all') {
            url = `/api/branches`;
        } else {
            url = `/api/branches/${supermarketId}`;
        }
        fetch(url)
            .then(res => res.json())
            .then(data => {
                document.getElementById('total-branches-value').textContent = data.length;
            })
            .catch(err => console.error(err));
    });
</script>
{% endblock %}